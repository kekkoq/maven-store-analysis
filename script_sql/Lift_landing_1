WITH conversion_test_analysis AS (
    SELECT
        CASE WHEN ws.is_repeat_session = 1 THEN "repeat" ELSE "new" END AS session_type,
        wp.pageview_url AS landing_page,
        COUNT(DISTINCT ws.website_session_id) AS test_sessions,
        COUNT(DISTINCT od.order_id) AS test_orders,
        (COUNT(DISTINCT od.order_id) * 1.0) / COUNT(DISTINCT ws.website_session_id) AS conversion_rate
    FROM website_sessions AS ws
    INNER JOIN website_pageviews AS wp
        ON ws.website_session_id = wp.website_session_id
        -- Ensure this is the FIRST pageview in the session
        AND wp.website_pageview_id = (
            SELECT MIN(wp_sub.website_pageview_id)
            FROM website_pageviews AS wp_sub
            WHERE wp_sub.website_session_id = ws.website_session_id
        )
    LEFT JOIN orders AS od
        ON ws.website_session_id = od.website_session_id
    WHERE 
        ws.created_at < '2012-07-28' -- End date for the experiment
        AND wp.website_pageview_id >= 23504 -- Start pageview ID (can be simplified if '2012-06-19' is the actual start date)
        AND ws.utm_campaign = 'nonbrand'
        AND ws.utm_source = 'gsearch'
        AND wp.pageview_url IN ('/lander-1', '/home') -- Only for the test pages
    GROUP BY 1,2
)
SELECT
    session_type,
    MAX(CASE WHEN landing_page = '/lander-1' THEN conversion_rate END) AS lander_1_rate,
    MAX(CASE WHEN landing_page = '/home' THEN conversion_rate END) AS home_rate
    FROM conversion_test_analysis
